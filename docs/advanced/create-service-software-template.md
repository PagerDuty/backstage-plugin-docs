# Create PagerDuty service with Software Templates

The PagerDuty backend plugin provides a custom action that you can use in your [Backstage Software Templates](<https://backstage.io/docs/features/software-templates/>) to create services in PagerDuty easily. This custom action not only creates the service, but also automatically configures a Backstage integration and adds its integration key to the Backstage Service configuration.

By doing so, it enables and configures the PagerDuty Card provided by the frontend plugin directly on your service page, eliminating the need for manual configuration and enhancing the user experience.

## Adding the backend plugin

This step is already covered on the `Getting Started` section of the documentation but if you haven't installed the package do it by running the following command from the root folder of your Backstage project.

```bash
yarn add --cwd packages/backend @pagerduty/backstage-plugin-backend # (1)! 
```

1. This command adds `@pagerduty/backstage-plugin-backend` package to the `packages/backend` folder because it is a backend plugin.

## Adding the custom action to a Software Template

Software Templates can be simple or complex depending on the practices you are trying to standardize across your teams. Here, we provide a simple example of a template that requests basic information for a Backstage service and augments that with information relevant for creating the service in PagerDuty.

!!! note
    We assume you have an `examples/template/content` folder which is automatically create when you use `npx @backstage/create-app` to create your Backstage project.

### Create project configuration file

In your `examples/template/content` folder you should create `catalog-info.yaml` file if you don't have one already. Update its content to something like this:

```yaml
apiVersion: backstage.io/v1alpha1
kind: Component
metadata:
  name: ${{ values.name | dump }}
  annotations:
    pagerduty.com/integration-key: ${{ values.integrationKey | dump }}
    pagerduty.com/service-id: ${{ values.serviceId | dump }}
spec:
  type: website
  lifecycle: experimental
  owner: guests
```

In the software template we will either replace the values for the `integration-key`, `service-id` and `name` or completely remove the parameters from the configuration.

!!! note
    You don't need to use this exact template but to automate the configuration for the PagerDuty Card you need to have at least the `integration-key` or the `service-id` parameters.

### Create the Software Template

Now that we have defined the contents of the new project we will be creating through a Software Template, we need to create the template itself.

Software templates are composed of **input parameters**, **steps** and **outputs**. In the following template we provide the user with two pages:

1. Collecting information about the service itself
2. Collecting information on where the code is going to be hosted

Once all the information is provided by the user we will:

1. create a Service in PagerDuty
2. parse the `catalog-info.yaml` file and replace the variables with the values generated by the previous step
3. publish the code to GitHub
4. register the component in Backstage

```yaml
apiVersion: scaffolder.backstage.io/v1beta3
kind: Template
metadata:
  name: create-pagerduty-service
  title: Create PagerDuty Service
  description: Creates service in PagerDuty
spec:
  owner: pagerduty
  type: service

  parameters:
    - title: PagerDuty Service
      properties:
        service_name:
          title: Service Name
          type: string
          description: The name of the service
        description:
          title: Description
          type: string
          description: The description of the service
        escalation_policy_id:
          title: Escalation Policy ID
          type: string
          description: The ID of the escalation policy to associate with the service
    
    - title: Choose a location
      required:
        - repoUrl
      properties:
        repoUrl:
          title: Repository Location
          type: string
          ui:field: RepoUrlPicker
          ui:options:
            allowedHosts:
              - github.com

  steps:
    - id: pagerdutyService
      name: Create PagerDuty Service
      action: pagerduty:service:create
      input:
        name: ${{ parameters.service_name }}
        description: ${{ parameters.description }}
        escalationPolicyId: ${{ parameters.escalation_policy_id }}
    
    - id: fetch-base
      name: Fetch Base
      action: fetch:template
      input:
        url: ./content
        templateFileExtension: '.yaml'
        values:
          name: ${{ parameters.service_name }}
          serviceId: ${{ steps['pagerdutyService'].output.serviceId }}
          integrationKey: ${{ steps['pagerdutyService'].output.integrationKey }}
    
    - id: publish
      name: Publish
      action: publish:github
      input:
        allowedHosts: ['github.com']
        description: This is ${{ parameters.name }}
        repoUrl: ${{ parameters.repoUrl }}
    
    - id: register
      name: Register
      action: catalog:register
      input:
        repoContentsUrl: ${{ steps['publish'].output.repoContentsUrl }}
        catalogInfoPath: '/catalog-info'
    

  output:
    links:
      - title: Open in PagerDuty
        url: ${{ steps['pagerdutyService'].output.serviceUrl }}
    text:
      - title: Integration Key
        text: ${{ steps['pagerdutyService'].output.integrationKey }}

```

This is an easy mechanism for onboarding new services in an automated way, ensuring that Backstage and PagerDuty services can be **provisioned with one step and in a self-service way**.
